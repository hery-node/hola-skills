---
name: hola-router
description: RESTful API endpoints provided by init_router() in Hola framework. Use when implementing API calls, understanding CRUD operations, working with entity lists/searches, handling references, or debugging API responses. Covers all auto-generated routes with params, body, response formats, and permissions.
---

# Hola Router - RESTful API Endpoints

Complete reference for all endpoints auto-generated by `init_router()`.

## Endpoint Overview

| Method | Path            | Purpose                   | Permission Flag          |
| ------ | --------------- | ------------------------- | ------------------------ |
| GET    | `/`             | Simple list with defaults | `readable`               |
| POST   | `/list`         | List/search entities      | `readable`               |
| GET    | `/meta`         | Get field metadata & mode | `readable`               |
| GET    | `/ref`          | Get reference labels      | `readable` + `ref_label` |
| GET    | `/:id`          | Get single entity         | `readable`               |
| GET    | `/:id/property` | Get specific properties   | `readable`               |
| POST   | `/`             | Create entity             | `creatable`              |
| PUT    | `/:id`          | Update entity             | `updatable`              |
| DELETE | `/:id`          | Delete entity             | `deleteable`             |
| POST   | `/:id/clone`    | Clone entity              | `cloneable`              |

## 1. GET /{collection}/

Simple list endpoint with optional parameters and sensible defaults. Use this for quick data retrieval without specifying all query options.

### Permission

- Requires: `readable: true`
- User auth: `settings.server.check_user`
- Filter: Auto-applies `user_field` if defined

### Query Params (All Optional)

```typescript
{
  attr_names?: string;   // Default: list field names from meta
  sort_by?: string;      // Default: primary key or "_id"
  desc?: boolean;        // Default: true (descending)
  page?: number;         // Default: 1
  limit?: number;        // Default: settings.server.threshold.default_list_limit (1000)
}
```

### Response

```typescript
{
  code: 0,           // SUCCESS
  total: number,     // Total matching records
  data: [            // Array of entities
    {
      _id: string,
      // ... entity fields
    }
  ]
}
```

### Example

```typescript
// Request - minimal (uses all defaults)
GET /task/

// Request - with optional params
GET /task/?sort_by=created_at&desc=true&limit=50

// Response
{
  "code": 0,
  "total": 45,
  "data": [
    {
      "_id": "507f1f77bcf86cd799439011",
      "title": "Task 1",
      "status": 1,
      "created_at": "2026-01-30T10:00:00Z"
    }
  ]
}
```

### Notes

- Simpler alternative to POST /list for basic queries
- All parameters are optional with sensible defaults
- Default limit is configurable via `settings.server.threshold.default_list_limit`
- Supports all the same filtering via `user_field` as POST /list

## 2. POST /{collection}/list

List/search entities with filtering, sorting, and pagination.

### Permission

- Requires: `readable: true`
- User auth: `settings.server.check_user`
- Filter: Auto-applies `user_field` if defined

### Request Body

```typescript
{
  // Pagination
  page?: number;        // Default: 1
  page_size?: number;   // Default: 20

  // Filtering
  filter?: {
    field_name?: string | number | boolean;
    // MongoDB query operators supported
  };

  // Sorting
  sort?: {
    field_name: 1 | -1;  // 1=ascending, -1=descending
  };

  // Search (text search)
  search?: string;
}
```

### Response

```typescript
{
  code: 0,           // SUCCESS
  data: {
    total: number,   // Total matching records
    list: [          // Array of entities
      {
        _id: string,
        // ... entity fields
      }
    ]
  }
}
```

### Example

```typescript
// Request
POST /task/list
{
  "filter": { "status": 1 },
  "sort": { "created_at": -1 },
  "page": 1,
  "page_size": 20
}

// Response
{
  "code": 0,
  "data": {
    "total": 45,
    "list": [
      {
        "_id": "507f1f77bcf86cd799439011",
        "title": "Task 1",
        "status": 1,
        "created_at": "2026-01-30T10:00:00Z"
      }
    ]
  }
}
```

### Notes

- If `meta.user_field` is set (e.g., "owner"), auto-filters by `user.sub`
- Calls `meta.list_query` hook if defined
- Returns fields from `meta.property_fields` (excludes `sys` and `secure`)

## 3. GET /{collection}/meta

Get entity metadata including fields and permission mode.

### Permission

- Requires: `readable: true`
- User auth: `settings.server.check_user`

### Query Params

```typescript
{
  view?: string;  // Optional: filter fields by view ("*" = all)
}
```

### Response

```typescript
{
  code: 0,
  data: {
    mode: string,           // e.g., "crsu" (create, read, search, update)
    fields: [
      {
        name: string,
        type: string,
        required?: boolean,
        default?: any,
        ref?: string,
        link?: string,
        create?: boolean,
        update?: boolean,
        search?: boolean,
        list?: boolean,
        clone?: boolean,
        view?: string | string[]
      }
    ]
  }
}
```

### Example

```typescript
// Request
GET /user/meta

// Response
{
  "code": 0,
  "data": {
    "mode": "crsu",
    "fields": [
      { "name": "email", "type": "email", "required": true },
      { "name": "name", "type": "string" },
      { "name": "status", "type": "user_status", "default": 0 }
    ]
  }
}
```

### Mode Characters

| Char | Permission   | Meta Flag    |
| ---- | ------------ | ------------ |
| `c`  | Create       | `creatable`  |
| `r`  | Read         | `readable`   |
| `s`  | Search       | `readable`   |
| `u`  | Update       | `updatable`  |
| `d`  | Delete       | `deleteable` |
| `b`  | Batch delete | `deleteable` |
| `o`  | Clone        | `cloneable`  |
| `i`  | Import       | `importable` |
| `e`  | Export       | `exportable` |

### Notes

- Only returns fields visible in UI (`create`, `update`, `search`, or `list` = true)
- Excludes `sys: true` fields (server-only)
- `user_field` attribute is excluded from response
- Mode calculated by `meta.get_role_mode(user?.role)`

## 4. GET /{collection}/ref

Get reference labels for autocomplete/dropdowns.

### Permission

- Requires: `readable: true` AND `ref_label` defined
- User auth: `settings.server.check_user`

### Query Params

```typescript
{
  query?: string;         // Search query for filtering
  ref_by_entity?: string; // Entity requesting the reference
}
```

### Response

```typescript
{
  code: 0,
  data: [
    {
      title: string,   // Display label (from ref_label field)
      value: string    // Entity _id
    }
  ]
}
```

### Example

```typescript
// Meta definition
{
  collection: "user",
  ref_label: "name",  // Required for /ref endpoint
  // ...
}

// Request
GET /user/ref?query=john

// Response
{
  "code": 0,
  "data": [
    { "title": "John Doe", "value": "507f1f77bcf86cd799439011" },
    { "title": "John Smith", "value": "507f191e810c19729de860ea" }
  ]
}
```

### Notes

- Calls `entity.get_filtered_ref_labels()` with `ref_filter` if defined
- Useful for populating dropdowns in forms when referencing this entity
- Applies `user_field` filtering if defined

## 5. GET /{collection}/:id

Get a single entity by ID.

### Permission

- Requires: `readable: true`
- User auth: `settings.server.check_user`

### URL Params

```typescript
{
  id: string; // MongoDB ObjectId as string
}
```

### Response

```typescript
{
  code: 0,
  data: {
    _id: string,
    // ... all entity fields (excluding sys and secure)
  }
}
```

### Example

```typescript
// Request
GET /task/507f1f77bcf86cd799439011

// Response
{
  "code": 0,
  "data": {
    "_id": "507f1f77bcf86cd799439011",
    "title": "Complete documentation",
    "status": 1,
    "owner": "507f191e810c19729de860ea",
    "owner_name": "John Doe"  // Link field auto-populated
  }
}
```

### Notes

- Calls `meta.after_read` hook if defined
- Returns fields from `meta.property_fields`
- Link fields automatically populated from references
- Throws `NotFoundError` if entity doesn't exist

## 6. GET /{collection}/:id/property

Get specific properties of an entity (partial read).

### Permission

- Requires: `readable: true`
- User auth: `settings.server.check_user`

### URL Params

```typescript
{
  id: string; // MongoDB ObjectId as string
}
```

### Query Params

```typescript
{
  fields?: string;  // Comma-separated field names or "*" for all
}
```

### Response

```typescript
{
  code: 0,
  data: {
    // Only requested fields
  }
}
```

### Example

```typescript
// Request
GET /task/507f1f77bcf86cd799439011/property?fields=title,status

// Response
{
  "code": 0,
  "data": {
    "title": "Complete documentation",
    "status": 1
  }
}
```

### Notes

- More efficient than full read when only a few fields needed
- Useful for fetching labels or status without full entity
- Throws `NotFoundError` if entity doesn't exist

## 7. POST /{collection}/

Create a new entity.

### Permission

- Requires: `creatable: true`
- User auth: `settings.server.check_user`

### Request Body

```typescript
{
  // Field values based on meta.create_fields
  field_name: value,
  // ...
}
```

### Response

```typescript
{
  code: 0,
  data: {
    _id: string,      // Newly created entity ID
    // ... all entity fields
  }
}
```

### Example

```typescript
// Request
POST /task/
{
  "title": "New task",
  "status": 0,
  "priority": 3
}

// Response
{
  "code": 0,
  "data": {
    "_id": "507f1f77bcf86cd799439011",
    "title": "New task",
    "status": 0,
    "priority": 3,
    "owner": "507f191e810c19729de860ea",  // Auto-set from user_field
    "created_at": "2026-01-30T10:00:00Z"   // Set by before_create hook
  }
}
```

### Processing Steps

1. **Apply default values** - From `field.default` for `meta.create_fields`
2. **Set user_field** - Auto-populated from `user.sub` if defined
3. **Add user context** - `data._user = user` for hooks
4. **Call before_create** - Hook can modify `data` before validation
5. **Validate types** - Field type conversion and validation
6. **Insert to DB** - Create entity in MongoDB
7. **Call after_create** - Hook for post-creation logic

### Notes

- No Elysia schema validation - allows hooks to set required fields
- `sys` fields cannot be set by client (throws error)
- `secure` fields cannot be set by client
- Validation happens in Entity layer after hooks

## 8. PUT /{collection}/:id

Update an existing entity.

### Permission

- Requires: `updatable: true`
- User auth: `settings.server.check_user`

### URL Params

```typescript
{
  id: string; // MongoDB ObjectId as string
}
```

### Request Body

```typescript
{
  // Field values to update (from meta.update_fields)
  field_name: value,
  // ...
}
```

### Response

```typescript
{
  code: 0,
  data: {
    _id: string,
    // ... updated entity fields
  }
}
```

### Example

```typescript
// Request
PUT /task/507f1f77bcf86cd799439011
{
  "status": 2,
  "priority": 5
}

// Response
{
  "code": 0,
  "data": {
    "_id": "507f1f77bcf86cd799439011",
    "title": "New task",
    "status": 2,           // Updated
    "priority": 5,         // Updated
    "updated_at": "2026-01-30T11:00:00Z"  // Set by before_update hook
  }
}
```

### Processing Steps

1. **Call before_update** - Hook can modify `data` before validation
2. **Validate types** - Field type conversion and validation
3. **Update in DB** - Update entity in MongoDB
4. **Call after_update** - Hook for post-update logic

### Notes

- Only fields in `meta.update_fields` can be updated
- `sys` fields cannot be updated by client
- `user_field` cannot be changed
- Primary keys cannot be updated
- Uses Elysia schema validation

## 9. DELETE /{collection}/:id

Delete an entity by ID.

### Permission

- Requires: `deleteable: true`
- User auth: `settings.server.check_user`

### URL Params

```typescript
{
  id: string; // MongoDB ObjectId as string
}
```

### Response

```typescript
{
  code: 0,
  data: {
    deleted_count: number  // Number of entities deleted
  }
}
```

### Example

```typescript
// Request
DELETE /task/507f1f77bcf86cd799439011

// Response
{
  "code": 0,
  "data": {
    "deleted_count": 1
  }
}
```

### Processing Steps

1. **Call before_delete** - Hook can prevent deletion or perform checks
2. **Delete from DB** - Remove entity from MongoDB
3. **Handle cascade** - Delete/update related entities based on `delete` mode
4. **Call after_delete** - Hook for cleanup logic

### Notes

- Supports cascade deletion if other entities reference this one
- Cascade behavior controlled by `delete: "cascade"` on ref fields
- Throws error if entity has references and cascade not configured

## 10. POST /{collection}/:id/clone

Clone an existing entity with optional field overrides.

### Permission

- Requires: `cloneable: true`
- User auth: `settings.server.check_user`

### URL Params

```typescript
{
  id: string; // MongoDB ObjectId of entity to clone
}
```

### Request Body

```typescript
{
  // Optional field overrides
  field_name?: value,
  // ...
}
```

### Response

```typescript
{
  code: 0,
  data: {
    _id: string,      // New entity ID (different from source)
    // ... cloned entity fields
  }
}
```

### Example

```typescript
// Request
POST /task/507f1f77bcf86cd799439011/clone
{
  "title": "Cloned task - modified"
}

// Response
{
  "code": 0,
  "data": {
    "_id": "507f191e810c19729de860ea",  // New ID
    "title": "Cloned task - modified",   // Override
    "status": 0,                         // Copied from original
    "priority": 3,                       // Copied from original
    "owner": "507f191e810c19729de860ea"  // Set to cloning user
  }
}
```

### Processing Steps

1. **Read source entity** - Fetch original entity
2. **Copy clone_fields** - Only fields where `clone !== false`
3. **Apply overrides** - Merge request body fields
4. **Set user_field** - Auto-populated from `user.sub` (cloned entity belongs to user)
5. **Add user context** - `data._user = user` for hooks
6. **Call before_clone** - Hook can modify clone data
7. **Create new entity** - Insert as new record with new `_id`
8. **Call after_clone** - Hook for post-clone logic

### Notes

- No Elysia schema validation - allows hooks to set required fields
- Primary keys are NOT copied (new entity gets new keys)
- `sys` fields are NOT copied
- Useful for duplicating templates or base configurations

## Custom Routes

You can add custom endpoints using the `route` callback:

```typescript
export const router = init_router({
  collection: "task",
  // ... meta definition

  route: (router, meta) => {
    // Add custom endpoint
    router.get("/stats", async ({ user }) => {
      const entity = new Entity(meta);
      const total = await entity.count_entity({});
      return { code: 0, data: { total } };
    });

    // Add custom POST endpoint
    router.post("/batch-update", async ({ user, body }) => {
      // Custom logic
      return { code: 0 };
    });
  },
});
```

## Error Responses

All endpoints return consistent error format:

```typescript
{
  code: number,      // Error code (non-zero)
  message: string,   // Error message
  errors?: [         // Validation errors (if applicable)
    {
      field: string,
      message: string
    }
  ]
}
```

### Common Errors

| Code | Error             | Reason                                      |
| ---- | ----------------- | ------------------------------------------- |
| 403  | `NoRightsError`   | User lacks permission or meta flag disabled |
| 404  | `NotFoundError`   | Entity ID not found                         |
| 400  | `ValidationError` | Type conversion or validation failed        |
| 401  | `AuthError`       | No authentication when `check_user: true`   |

## Authentication Context

All endpoints receive `user` from JWT token:

```typescript
{
  user?: {
    sub: string,      // User ID
    role?: string,    // User role for permission checking
    // ... other JWT claims
  }
}
```

- Auto-injected by auth plugin
- Used for `user_field` filtering and population
- Available in all lifecycle hooks via `data._user`

## Best Practices

### 1. Use /meta Before Forms

Fetch metadata to build dynamic forms:

```typescript
const { data } = await fetch("/user/meta");
// Use data.fields to build create/update form
// Use data.mode to show/hide action buttons
```

### 2. Leverage /ref for Dropdowns

```typescript
const { data } = await fetch("/user/ref?query=john");
// data = [{ title: "John Doe", value: "507..." }]
// Populate autocomplete/select options
```

### 3. Use /property for Efficiency

```typescript
// ❌ Inefficient - fetches all fields
const { data } = await fetch("/task/507f.../");

// ✅ Efficient - only fetch what you need
const { data } = await fetch("/task/507f.../property?fields=title,status");
```

### 4. Handle user_field Automatically

Don't send `user_field` in create/update - it's auto-set:

```typescript
// ❌ Don't do this
POST / task / { owner: "507f..." }; // Will be ignored/overwritten

// ✅ Correct - let framework set it
POST / task / { title: "Task" }; // owner auto-set from user.sub
```

## Related Skills

- `hola-meta` - Define entity metadata with field visibility
- `crud-create-router` - Generate complete CRUD routers
- `entity-find` - Entity layer operations and hooks
